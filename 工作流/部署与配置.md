[link]: http://open.hand-china.com/document-center/doc/product/10003/10011?_back=%2Fdocument-center%3Fs%3D%25E4%25BB%25BB%25E5%258A%25A1%25E8%25B0%2583%25E5%25BA%25A6

## 导言

### Choerodon 系统部署架构

Choerodon 猪齿鱼作为一套 PaaS 平台，目前对于通过 Choerodon 开发部署的应用系统有多种部署方式，并且由于 Choerodon 现在仅支持基于 Kubernetes 部署的应用系统，所以，部署方式根据 Kubernetes 集群不同而不同。

### 单Kubernetes集群部署

Choerodon 与应用系统部署在一个 Kubernetes 集群中。可以在一个 Kubernetes 集群中安装应用系统的开发环境、测试环境以及正式环境。

### 多Kubernetes集群部署

Choerodon 与应用系统开发环境部署在同一个 Kubernetes 集群中，应用系统的测试环境和正式环境则分别部署到单独的一个Kubernetes集群中。

---

## 组件安装列表

### 基础组件列表

| 组件                     | 描述                     | 服务版本                     | Chart版本 |
| ------------------------ | ------------------------ | ---------------------------- | --------- |
| Docker                   | Docker                   | 19.03.6-ce                   | -         |
| kube-proxy               | kube-proxy               | v1.16.7                      | -         |
| kube-apiserver           | kube-apiserver           | v1.16.7                      | -         |
| kube-controller-manager  | kube-controller-manager  | v1.16.7                      | -         |
| kube-scheduler           | kube-scheduler           | v1.16.7                      | -         |
| etcd                     | etcd                     | 3.4.3-0                      | -         |
| coredns                  | coredns                  | 1.3.1                        | -         |
| kube-flannel             | kube-flannel             | v0.11.0-amd64                | -         |
| kubernetes-dashboard     | kubernetes-dashboard     | v2.0.0-rc5                   | -         |
| nginx-ingress-controller | nginx-ingress-controller | 0.29.0                       | -         |
| Helm                     | Helm                     | 2.16.3                       | -         |
| Chartmuseum              | Kubernetes应用私有包仓库 | v0.11.0                      | 2.6.0     |
| Minio                    | 对象存储服务             | RELEASE.2020-01-03T19-12-21Z | 4.0.1     |
| Redis                    | 缓存数据库               | 4.0.11                       | 0.2.3     |
| Mysql                    | 数据库                   | 5.7.23                       | 0.1.2     |
| Harbor                   | 容器的镜像库             | v1.9.3                       | 1.2.3     |
| Gitlab                   | 代码托管                 | 11.11.7-ce.0                 | 0.5.3     |
| Gitlab-Runner            | CI/CD 运行环境           | v11.11.4                     | 0.2.4     |
| elasticsearch-kb         | 知识ES服务               | 7.2-elasticsearch-kb         | 0.21.0    |

### Choerodon服务列表

| 组件                  | 描述           | 版本   |
| --------------------- | -------------- | ------ |
| go register server    | 注册服务       | 0.21.0 |
| manager service       | 管理服务       | 0.21.0 |
| base service          | 基础服务       | 0.21.5 |
| api gateway           | 网关服务       | 0.21.0 |
| oauth server          | 认证服务       | 0.21.1 |
| file service          | 文件服务       | 0.21.0 |
| notify service        | 通知服务       | 0.21.1 |
| asgard service        | 事务服务       | 0.21.1 |
| gitlab service        | Gitlab 服务    | 0.21.0 |
| devops service        | Devops 服务    | 0.21.2 |
| workflow service      | 工作流服务     | 0.21.0 |
| agile service         | 敏捷管理       | 0.21.1 |
| test manager service  | 测试管理服务   | 0.21.1 |
| knowledgebase service | 知识服务       | 0.21.0 |
| choerodon front       | Choerodon 前端 | 0.21.2 |

---

## 安装方式

Choerodon提供两种安装方式，即一键部署Choerodon和分步部署Choerodon。

### 一键部署Choerodon

一键部署Choerodon是为了简化Choerodon安装步骤，通过shell脚本将Choerodon及其所需要的组件，统一进行安装及配置。用户仅需要简单的配置相关参数，运行shell命令即可。

### 分步部署Choerodon

分步部署Choerodon是分组件一步一步的安装Choerodon及所需组件，用户可以定制相关的安装。分步部署Choerodon适合非常了解Choerodon架构，需要定制部署Choerodon的人群。

> 一键部署Choerodon和分步部署Choerodon要求服务器能够与外网连接。用户可以根据自身的实际情况选择合适的安装方式。

---

## 安装要求与约定

Choerodon采用Spring Cloud作为微服务框架，运行在Docker上，以Kubernetes作为容器的编排工具。理论上只要服务器资源允许，可以运行Kubernetes，就可以运行Choerodon。Choerodon不是一个单体应用系统，而是一个包含多个微服务的分布式系统，所以部署相对比较复杂。目前，我们提供基于**Helm**的部署方式，以提高部署效率。

### 硬件最低要求

- 节点数量：4
- 单节点内存信息：16G及以上
- 单节点处理器信息：4核4线程及以上
- 单节点硬盘：100G及以上（如使用NFS存储，那么NFS服务节点建议存储不小于512G）

> 只要现有节点内存与CPU总和大于上述节点要求即可。

### 软件要求

- 系统版本：CentOS7.4及以上
- Kubernetes：1.10及以上
- Helm：2.16

### 需开放的端口号

| **控制平面节点**  |      |             |                              |                     |
| ----------------- | ---- | ----------- | ---------------------------- | ------------------- |
| 协议              | 方向 | 端口范围    | 使用者                       | 用途                |
| TCP               | 入站 | 6443        | Kubernetes APIserver         | All                 |
| TCP               | 入站 | 2379-2380   | etcd server clientAPI        | kube-apiserver,etcd |
| TCP               | 入站 | 10248,10250 | Kubelet API                  | Self,Controlplane   |
| TCP               | 入站 | 10251,10259 | kube-scheduler               | Self                |
| TCP               | 入站 | 10252,10257 | kube-controller-manager      | Self                |
| **工作节点**      |      |             |                              |                     |
| 协议              | 方向 | 端口范围    | 使用者                       | 用途                |
| tcp               | 入站 | 80          | ingress-controller           | All                 |
| tcp               | 入站 | 443         | ingress-controller           | All                 |
| tcp               | 入站 | 30080       | ingress-controller           | All                 |
| tcp               | 入站 | 30443       | ingress-controller           | All                 |
| TCP               | 入站 | 10248,10250 | KubeletAPI                   | Self,Controlplane   |
| TCP               | 入站 | 30000-32767 | NodePort Services*           | All                 |
| TCP               | 入站 | 10256       | kube-proxy                   | 健康检查            |
| **Flannel**       |      |             |                              |                     |
| 协议              | 方向 | 端口范围    | 使用者                       | 用途                |
| UDP               | 双向 | 8285        | flannel networking(UDP)      | 收发封装数据包      |
| UDP               | 双向 | 8472        | flannel networking(VXLAN)    | 收发封装数据包      |
| **Calico**        |      |             |                              |                     |
| 协议              | 方向 | 端口范围    | 使用者                       | 用途                |
| TCP               | 双向 | 179         | Calico networking(BGP)       | 收发封装数据包      |
| TCP               | 双向 | 5473        | Calico networking with Typha | 收发封装数据包      |
| **Kube-ovn**      |      |             |                              |                     |
| 协议              | 方向 | 端口范围    | 使用者                       | 用途                |
| udp               | 双向 | 6081        | kube-ovn                     | 收发封装数据包      |
| tcp               | 入站 | 6641        | ovsdb-server                 | 数据存储            |
| tcp               | 入站 | 6642        | ovsdb-server                 | 数据存储            |
| **load-balancer** |      |             |                              |                     |
| 协议              | 方向 | 端口范围    | 使用者                       | 用途                |
| tcp               | 入站 | 8443        | nginx,haproxy,envoy          | lb kube-apiserver   |
| tcp               | 入站 | 8081        | nginx,haproxy,envoy          | 健康检查            |
| tcp               | 入站 | 9090        | haproxy,envoy                | 管理端口            |

### 网络要求

- 各个服务器之间内网互通内网带宽建议1Gbps以上
- 各个服务器能够访问外网

### 约定

- 非特别说明，请使用具有root权限的用户进行安装操作
- 部署教程以NFS类型的PV为例进行创建，所有非集群级对象都创建在`c7n-system`命名空间下

---

