## 测试管理服务

`Test Manager Service` 是猪齿鱼核心服务之一 ，该服务是Choerodon微服务框架的测试管理中心。它的主要功能包括测试用例管理、测试循环、测试报表分析、自动化测试等。

### 特点

- **测试用例**（创建、查看和编辑测试用例、测试用例树、excel导入和导出等）
- **测试计划**（创建测试循环、测试阶段以及批量克隆循环等）
- **测试执行**（执行测试、搜索执行、记录步骤结果、查看执行测试详情、删除执行）
- **自定义状态**（状态列表，创建状态）
- **自动化测试**（自动化模板包括：`mocha`、`testNG`、`selenium`，编写测试内容，执行自动化测试，查看测试结果）
- **设置**（自定义状态）

### 依赖

- Java8
- mysql 5.6+
- redis 4.0+
- [File Service](https://github.com/choerodon/file-service.git)
- [go-register-server](https://github.com/choerodon/go-register-server.git)
- [agile-service](https://github.com/choerodon/agile-service.git)
- [Iam Service](https://github.com/choerodon/iam-service.git)
- [DevOps Service](https://github.com/choerodon/devops-service.git)
- [Redis](https://redis.io/)
- [MySQL](https://www.mysql.com/)

### 服务配置

- application.yml

```yaml
spring:
datasource:
  url: jdbc:mysql://localhost:3306/test_manager_service?useUnicode=true&characterEncoding=utf-8&useSSL=false&useInformationSchema=true&remarks=true
  username: choerodon
  password: 123456
aop:
  auto: true
http:
  encoding:
    charset: UTF-8
    force: true
    enabled: true
redis:
  host: localhost
  port: 6379
servlet:
  multipart:
    max-file-size: 30MB
    max-request-size: 30MB
choerodon:
saga:
  consumer:
    enabled: true # 是否启用消费端
    thread-num: 5  # 消费线程数
    max-poll-size: 200 # 每次拉取的最大消息数量
    poll-interval-ms: 1000 # 拉取消息的间隔(毫秒)，默认1000毫秒
schedule:
  consumer:
    enabled: true # 启用任务调度消费端
    thread-num: 1 # 任务调度消费线程数
    poll-interval-ms: 1000 # 拉取间隔，默认1000毫秒
eureka:
instance:
  preferIpAddress: true
  leaseRenewalIntervalInSeconds: 1
  leaseExpirationDurationInSeconds: 3
client:
  serviceUrl:
    defaultZone: http://localhost:8000/eureka/
  registryFetchIntervalSeconds: 1
mybatis:
mapperLocations: classpath*:/mapper/*.xml
configuration:
  mapUnderscoreToCamelCase: true
feign:
hystrix:
  shareSecurityContext: true
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 30000
ribbon:
ConnectTimeout: 5000
ReadTimeout: 5000
logging:
level:
  root: info
  io.choerodon.test.manager: debug
```

- bootstrap.yml

```yaml
server:
port: 8093
spring:
application:
  name: test-manager-service
cloud:
  config:
    failFast: true
    retry:
      maxAttempts: 6
      multiplier: 1.5
      maxInterval: 2000
    uri: localhost:8010
    enabled: false
mvc:
  static-path-pattern: /**
resources:
  static-locations: classpath:/static,classpath:/public,classpath:/resources,classpath:/META-INF/resources,file:/dist
management:
server:
  port: 8094
endpoints:
  web:
    exposure:
      include: '*'
endpoint:
  health:
    show-details: "ALWAYS"
```

### 安装和启动步骤

- 运行 `eureka-server`，[代码在这里](https://code.choerodon.com.cn/choerodon-framework/eureka-server.git)。

- 拉取当前项目到本地

```shell
git clone https://code.choerodon.com.cn/choerodon-agile/test-manager-service.git
```

- 初始化数据库，本地创建 `test-manager-service` 数据表，代码如下：

```sql
CREATE USER 'choerodon'@'%' IDENTIFIED BY "123456";
CREATE DATABASE test_manager_service DEFAULT CHARACTER SET utf8;
GRANT ALL PRIVILEGES ON test_manager_service.* TO choerodon@'%';
FLUSH PRIVILEGES;
```

- 初始化 `test-manager-service` 数据表数据，运行项目根目录下的 `init-local-database.sh`，该脚本默认初始化数据库的地址为 `localhost`，若有变更需要修改脚本文件

```shell
sh init-local-database.sh
```

- 启动项目，项目根目录下运行 `mvn clean spring-boot:run` 命令，或者在本地集成环境中运行 `SpringBoot` 启动类 `/src/main/java/io/choerodon/buzz/TestManagerServiceApplication.java`

---

## 敏捷服务

`敏捷服务` 是猪齿鱼平台的核心服务。

该服务负责敏捷流程管理，包括问题管理、待办事项、发布版本、活跃冲刺、模块管理、报告等，并通过丰富的图形界面为用户提供更好的使用体验。

敏捷管理服务主要用来管理项目的 需求、计划和 执行。

<img src="https://minio.choerodon.com.cn/knowledgebase-service/file_829d7e921c984b4385b250a9a2e4adcc_blob.png" alt="image" style="zoom:80%;" />

### 特性

- `版本管理`：根据项目周期，您可以对软件项目追踪不同的版本，同时可以将对应的问题分配到版本中
- `活跃冲刺`：敏捷看板的活跃冲刺展示了团队目前正在进行的冲刺，能在此创建、更新、删除问题，也能将问题直接拖拽到其它列的任意状态中
- `问题管理`： 问题是任何项目的基石，一个问题可以是一个史诗，一个故事，一个任务，一个缺陷等。
- `代办事项管理`：待办事项是未完成的工作列表，您可以构建一个新的待办事项，或者对现有的待办事项进行处理，包括创建、排序和优先级别评估
- `模块管理`： 根据项目需求，可以分拆为多个模块，每个模块可以进行负责人划分，配置后可以将项目中的问题归类到对应的模块中。例如“后端任务”，“基础架构”等等
- `用户故事地图`： 利于产品管理者以及团队成员将产品待办问题清单转化为可视化的过程，确保团队以“客户至上”的心态来建立他们的产品，快速且实时地传递价值
- `报告`：报告会根据您项目的进展情况以多个维度直观地记录和展示您项目、迭代、版本、进度等汇总情况

### 基础需求

- Java8
- Redis
- [MySQL](https://www.mysql.com/)

### 安装和启动

1.初始化数据库

```sql
CREATE USER 'choerodon'@'%' IDENTIFIED BY "choerodon";
CREATE DATABASE agile_service DEFAULT CHARACTER SET utf8;GRANT ALL PRIVILEGES ON agile_service.* TO choerodon@'%';
FLUSH PRIVILEGES;
```

1. 运行命令 `sh init-local-database.sh`
2. 运行如下命令 或者 在 IntelliJ IDEA 中运行 `AgileServiceApplication`

```shell
mvn clean spring-boot:run
```

### 服务依赖

- `go-register-server`: 注册中心
- `mysql`: 敏捷服务数据库
- `api-gateway`: 网关服务
- `oauth-server`: 权限认证中心
- `manager-service`: 配置及路由管理服务
- `file-service` : 文件服务
- `knowledgebase-service` : 知识管理服务
- `notify-service` : 通知服务
- `iam-service`：用户、角色、权限、组织、项目、密码策略、快速代码、客户端、菜单、图标、多语言等管理服务

---

## 工作流服务（Workflow Service）

支持动态灵活地创建流程，启动流程、监控流程以及管理流程

### 功能

- 流水线管理

  此功能用于动态创建流水线Modal。

- 流水线实例管理

  此功能用于启动、删除流水线实例，审核人工审核任务。

- 用户管理功能

  此功能用于将Choerodon用户登录到Activiti7。

### 环境依赖

- JDK-8
- [Maven](http://www.maven-sf.com/)
- [MySQL](https://www.mysql.com/)
- [Activiti](https://www.activiti.org/)

### 安装与启动

1. 初始化数据库

   ```sql
   CREATE USER 'choerodon'@'%' IDENTIFIED BY "choerodon";
   CREATE DATABASE workflow_service DEFAULT CHARACTER SET utf8;
   GRANT ALL PRIVILEGES ON workflow_service.* TO choerodon@'%';
   FLUSH PRIVILEGES;
   ```

2. 执行下列命令或在 IntelliJ IDEA 中运行`WorkFlowServiceApplication`类

   ```shell
    mvn clean spring-boot:run
   ```

### 服务依赖

- `eureka-server`: 注册&配置中心
- `oauth-server` 认证中心
- `asgard-service`: Asgard 服务
- `MySQL`: workflow_service 数据库

---

## DevOps 服务

`DevOps Service` DevOps Service是Choerodon平台实现持续交付的基础. 当前版本为: `0.21.0`

DevOps Service通过自主整合的DevOps工具链，集成相关的开源工具，以此形成了计划、编码、测试、部署、运维以及监控的DevOps闭环。
并且只需通过简单的配置，您便能获得最佳的开发体验。

### 特性

`DevOps Service` 含有以下功能:

- `应用服务管理` ：对应用服务进行管理
- `应用服务版本管理`：对`持续集成`（Continuous Integration）过程中产生的可以直接在`Kubernetes`集群中进行部署的服务版本进行管理
- `代码管理及版本控制`：对服务的代码进行版本控制和管理
- `分支管理`：能够对服务的`Git`分支进行相应的操作
- `代码质量监测`：在`CI`过程中进行代码质量数据收集，集成`sonarqube`对代码质量进行监测
- `持续集成概览`：查看服务的持续集成过程
- `部署管理`：对持续集成所产生的服务版本通过`GitOps`进行部署
- `持续部署流水线管理`：使用工作流实现持续部署
- `资源管理`：对部署的资源（如：网络，域名，密文等）进行管理
- `集群管理`：管理`Kubernetes`集群

### 前置要求

- [JAVA](https://www.java.com/en/)：`DevOps Service`基于Java8进行开发
- [GitLab](https://about.gitlab.com/)：`DevOps Service`使用`GitLab`进行代码的托管。同时，通过基于`GitLab Runner`实现持续集成以完成代码编译，单元测试执行，代码质量分析，docker镜像生成，helm chart打包，服务版本发布等自动化过程
- [Harbor](https://vmware.github.io/harbor/cn/)：企业级Docker registry 服务，用于存放服务版本所对应的docker镜像
- [Kubernetes](https://kubernetes.io/)：容器编排管理工具，用于部署服务版本所对应的helm chart包
- [ChartMuseum](https://chartmuseum.com/)：Helm Chart仓库，用于存放服务版本所对应的helm chart包
- [Sonarqube](https://www.sonarqube.org/)：管理代码质量的开放平台，用于管理服务的代码质量
- [MySQL](https://www.mysql.com/)：主流数据库之一，用于`DevOps Service`的数据持久化
- [Redis](https://redis.io/)：内存数据库，用于数据缓存和部分非持久化数据存储

### 服务依赖

- `go-register-server`: 注册中心，在线上环境代替本地的`eureka-server`
- `iam-service`：用户服务，与用户有关的操作依赖与此服务
- `api-gateway`: 网关服务
- `oauth-server`: 授权服务
- `manager-service`: 管理服务
- `asgard-service` : 事务一致性服务
- `notify-service` : 通知服务
- `gitlab-service`：gitlab服务
- `workflow-service`：工作流服务
- `agile-service`：敏捷服务，查询与分支有关的敏捷Issue需要依赖此服务

### 服务配置

- `bootstrap.yml`:

  ```yaml
  server:
    port: 8060
  spring:
    application:
      name: devops-service
    cloud:
      config:
        failFast: true
        retry:
          maxAttempts: 6
          multiplier: 1.5
          maxInterval: 2000
        uri: localhost:8010
        enabled: false
    mvc:
      static-path-pattern: /**
    resources:
      static-locations: classpath:/static,classpath:/public,classpath:/resources,classpath:/META-INF/resources,file:/dist
  management:
    server:
      port: 8061
    endpoints:
      web:
        exposure:
          include: '*'
  ```

- `application.yml`:

  ```yaml
  spring:
    datasource:
      url: jdbc:mysql://localhost/devops_service?useUnicode=true&characterEncoding=utf-8&useSSL=false
      username: choerodon
      password: choerodon
      hikari:
        maximum-pool-size: 15 # 数据库连接池连接数
    redis:
      host: localhost
    http:
      encoding:
        charset: UTF-8
        force: true
        enabled: true
  services:
    harbor:
      baseUrl: "harbor.example.com" # harbor地址
      username: "123456" # harbor用户名
      password: "123456" # 对应harbor用户名的密码
      insecureSkipTlsVerify: false
    gitlab:
      url: "gitlab.example.com" # gitlab地址
      sshUrl: "gitlab.example.com" # 用于ssh操作的gitlab地址
      projectLimit: 100 # gitlab用户可以创建的项目的数量限制
    helm:
      url: "helm.example.com" # 存放helm chart包的仓库地址
    gateway:
      url: "http://api.example.com" # 网关地址
  choerodon:
    saga:
      consumer:
        core-thread-num: 20
        max-thread-num:  20 # 消费线程数
        poll-interval: 3 # 拉取消息的间隔(秒)，默认1秒
        enabled: true # 是否启用消费端
    schedule:
      consumer:
        enabled: true # 启用任务调度消费端
        thread-num: 1 # 任务调度消费线程数
        poll-interval-ms: 1000 # 拉取间隔，默认1000毫秒
  agent:
    version: "0.5.0" # devops-service此版本所预期的 choerodon-agent 的版本
    serviceUrl: "agent.example.com" # 用于 choerodon-agent 连接 devops-service 的地址
    certManagerUrl: "agent.example.com" # 存放CertManager的地址，用于安装
    repoUrl: "helm.example.com" # 存放agent的地址，用于安装
  eureka:
    instance:
      preferIpAddress: true
      leaseRenewalIntervalInSeconds: 1
      leaseExpirationDurationInSeconds: 3
    client:
      serviceUrl:
        defaultZone: http://localhost:8000/eureka/
      registryFetchIntervalSeconds: 1
  mybatis:
    mapperLocations: classpath*:/mapper/*.xml
    configuration:
      mapUnderscoreToCamelCase: true
  feign:
    hystrix:
      shareSecurityContext: true
      command:
        default:
          execution:
            isolation:
              thread:
                timeoutInMilliseconds: 30000
  ribbon:
    ConnectTimeout: 50000
    ReadTimeout: 50000
  asgard-servie:
    ribbon:
      ConnectTimeout: 50000
      ReadTimeout: 50000
  # 批量部署的请求条数限制
  devops:
    batch:
      deployment:
        maxSize: 20
  # websocket的最大缓冲区大小，单位字节byte
  websocket:
    buffer:
      maxTextMessageSize: 4194304
      maxBinaryMessageSize: 4194304
  ```

### 安装和启动步骤

1. 创建数据库`devops_service`，创建用户`choerodon`，并为用户分配权限：

   ```sql
   CREATE USER 'choerodon'@'%' IDENTIFIED BY "choerodon";
   CREATE DATABASE devops_service DEFAULT CHARACTER SET utf8;GRANT ALL PRIVILEGES ON devops_service.* TO choerodon@'%';
   FLUSH PRIVILEGES;
   ```

2. 拉取`DevOps Service`代码到本地：

   ```shell
   git clone https://github.com/choerodon/devops-service.git
   ```

3. 在项目根目录执行命令： `sh init-database.sh`

4. 使用下列命令运行或直接在集成环境中运行 `DevopsServiceApplication`

   ```shell
   mvn clean spring-boot:run
   ```

---

## Gitlab 服务

`Gitlab Service`通过引入外部java客户端与Gitlab进行交互。该客户端通过直接调用Gitlab提供的api，处理来自其他服务的Gitlab请求。

### 功能

- 项目组管理

  此功能用于对Gitlab的group进行管理，包括创建、删除、查询项目以及添加、移除、查询项目组成员等操作。

- WebHook管理

  此功能用于对Gitlab的ProjectHook进行管理，包括创建和查询ProjectHook详情等操作。

- 问题管理

  此功能用于对Gitlab的Issue进行管理，包括创建、更新、关闭Issue等操作。

- Label管理

  此功能用于对Gitlab的Label进行管理，包括查询、删除、订阅Label等操作。

- Merge Request管理

  此功能用于对Gitlab的Merge Request进行管理，包括创建、删除、查询Merge Request等操作。

- 项目管理

  此功能用于对Gitlab的Project进行管理，包括创建、更新、删除项目以及添加、移除项目成员等操作。

- 用户管理

  此功能用于对Gitlab的User进行管理，包括创建、更新、校验用户邮箱是否存在等操作。

### 环境依赖

- JDK-8
- [Maven](http://www.maven-sf.com/)
- [MySQL](https://www.mysql.com/)
- [Gitlab](https://gitlab.com/)
- [Kafka](https://kafka.apache.org/)

### 安装与启动

1. 初始化数据库

   ```sql
   CREATE USER 'choerodon'@'%' IDENTIFIED BY "choerodon";
   CREATE DATABASE gitlab_service DEFAULT CHARACTER SET utf8;
   GRANT ALL PRIVILEGES ON gitlab_service.* TO choerodon@'%';
   FLUSH PRIVILEGES;
   ```

2. 执行下列命令或在 IntelliJ IDEA 中运行`GitlabServiceApplication`类

   ```shell
    mvn clean spring-boot:run
   ```

### 服务依赖

- `eureka-server`: 注册&配置中心
- `oauth-server` 认证中心
- `MySQL`: gitlab_service 数据库

---

## 事务服务（asgard-service）

Choerodon Asgard Service 是一个任务调度服务，通过`saga` 实现微服务之间的数据一致性。

### 特征

实现数据最终一致性

### 服务配置

- `application.yml`

```yaml
spring:
    datasource:
      url: jdbc:mysql://localhost:3306/asgard_service?useUnicode=true&characterEncoding=utf-8&useSSL=false&useInformationSchema=true&remarks=true
      username: choerodon
      password: 123456
    # 配置redis，作为asgard服务的通知消息队列
    redis:
      host: localhost
      port: 6379
      database: 7
  eureka:
    instance:
      preferIpAddress: true
      leaseRenewalIntervalInSeconds: 10
      leaseExpirationDurationInSeconds: 30
      metadata-map:
        VERSION: v1
    client:
      serviceUrl:
        defaultZone: http://localhost:8000/eureka/
      registryFetchIntervalSeconds: 10
  hystrix:
    command:
      default:
        execution:
          isolation:
            thread:
              timeoutInMilliseconds: 20000
  ribbon:
    ReadTimeout: 5000
    ConnectTimeout: 5000
  notify-service:
    ribbon:
      MaxAutoRetries: 0
      MaxAutoRetriesNextServer: 0
  mybatis:
    mapperLocations: classpath*:/mapper/*.xml
    configuration: # 数据库下划线转驼峰配置
      mapUnderscoreToCamelCase: true
  choerodon:
    saga:
      consumer:
        enabled: true # 启动消费端
        thread-num: 2 # saga消息消费线程池大小
        max-poll-size: 200 # 每次拉取消息最大数量
        poll-interval-ms: 1000 # 拉取间隔，默认1000毫秒
    asgard:
      quartz:
        auto-startup: true
        overwrite-existing-jobs: true
        properties:
          org.quartz.jobStore.tablePrefix: QRTZ_
          org.quartz.jobStore.driverDelegateClass: org.quartz.impl.jdbcjobstore.StdJDBCDelegate
          org.quartz.jobStore.class: org.quartz.impl.jdbcjobstore.JobStoreTX
          org.quartz.jobStore.isClustered: true
          org.quartz.jobStore.misfireThreshold: 25000
          org.quartz.scheduler.makeSchedulerThreadDaemon: true
      saga:
        back-check-interval-ms: 1000 # 每隔多久回查(毫秒)
        un-confirmed-timeout-seconds: 300 # 没查超过多久仍未确认的消息(秒)
    eureka:
      event:
        max-cache-size: 300 # 存储的最大失败数量
        retry-time: 5 # 自动重试次数
        retry-interval: 3 # 自动重试间隔(秒)
        skip-services: config**, **register-server, **gateway**, zipkin**, hystrix**, oauth**
    schedule:
      consumer:
        enabled: true
        poll-interval-ms: 10000
  db:
    type: mysql
```

- `bootstrap.yml`

```yaml
server:
  port: 18080
spring:
  application:
    name: asgard-service
  cloud:
    config:
      failFast: true
      retry:
        maxAttempts: 6
        multiplier: 1.5
        maxInterval: 2000
      uri: localhost:8010
      enabled: false
  mvc:
    static-path-pattern: /**
  resources:
    static-locations: classpath:/static,classpath:/public,classpath:/resources,classpath:/META-INF/resources,file:/dist
management:
  endpoint:
    health:
      show-details: ALWAYS
  server:
    port: 18081
  endpoints:
    web:
      exposure:
        include: '*'
```

### 环境需求

- mysql 5.6+
- redis 3.0+
- 该项目是一个 Eureka Client 项目，启动后需要注册到 `EurekaServer`，本地环境需要 `eureka-server`，线上环境需要使用 `go-register-server`

### 安装和启动步骤

- 运行 `eureka-server`，[代码库地址](https://code.choerodon.com.cn/choerodon-framework/eureka-server.git)。

- 拉取当前项目到本地，执行如下命令：

  ```shell
   git clone https://code.choerodon.com.cn/choerodon-framework/asgard-service.git
  ```

- 创建数据库，本地创建 `asgard_service` 数据库和默认用户，示例如下：

  ```sql
  CREATE USER 'choerodon'@'%' IDENTIFIED BY "123456";
  CREATE DATABASE asgard_service DEFAULT CHARACTER SET utf8;GRANT ALL PRIVILEGES ON asgard_service.* TO choerodon@'%';
  FLUSH PRIVILEGES;
  ```

- 初始化 `asgard_service` 数据库，运行项目根目录下的 `init-local-database.sh`，该脚本默认初始化数据库的地址为 `localhost`，若有变更需要修改脚本文件

  ```shell
  sh init-local-database.sh
  ```

- 本地启动 redis-server

- 启动项目，项目根目录下执行如下命令：

  ```shell
   mvn spring-boot:run
  ```

---

## 网关服务

### 网关鉴权组件

> 组件编码 `hzero-gateway-helper-api`
>
> 组件编码 `hzero-gateway-helper-default`

### 简介

- `hzero-gateway-helper-api` 提供鉴权的顶层接口端点以及鉴权过滤器接口，产品或项目完全可以自定义鉴权逻辑或者加入特定的鉴权逻辑。
- `hzero-gateway-helper-default` 是 `hzero-gateway-helper-api` 的默认实现
- 组件坐标

```xml
<dependency>
	<groupId>org.hzero</groupId>
	<artifactId>hzero-gateway-helper</artifactId>
	<version>${hzero.service.version}</version>
</dependency>
```

### 黑名单和白名单

- 黑名单**禁止**某些符合特定规则的IP访问；白名单**仅允许**某些符合特定规则的IP访问。
- 使用时需要在`hzero-gateway-helper`服务的配置文件中添加下面的配置：

```yaml
hzero:
  filter:
    # 白名单配置
    white-list:
      # 是否启用，默认不启用
      enable: true
      # 匹配规则
      ip:
        - 172.10,11.0-100.*
        - 192.10,11.0-100.*
    # 白名单配置
    black-list:
      # 是否启用，默认不启用
      enable: true
      # 匹配规则
      ip:
        - 172.10,11.0-100.*
        - 192.10,11.0-100.*
```

- 在配置匹配的`IP`时，可以使用特定的规则来简化配置：
  - 匹配某个固定值：`固定值` (例如：172.20.0.128)
  - 匹配多个值：`值1,值2,值3` (例如：172.20.0.128,129)
  - 匹配一个段：`值1-值2` (例如：172-192.20.0.128-255; 注意：`值1-`**等同于固定值**；`值1-值2-值3`**等同于`值1-值3`**)
  - 匹配任意值：`*` (例如：172.20.0.*)
  - 多个规则之间可以组合使用，例如10,172-192.20.0-10.*
  - 多个规则之间不能嵌套，**例如172-\*会无法识别**

### GatewayHelper 鉴权

#### 鉴权过滤器

GatewayHelper 组件提供了一组过滤器来对API及用户鉴权，具体可参考 [基础服务调用链路](http://hzerodoc.saas.hand-china.com/zh/docs/installation-configuration/service-config/service-chain/)

#### 自定义鉴权

- hzero 提供了 `hzero-gateway-helper-api` 鉴权接口包 和 `hzero-gateway-helper-default` 默认实现。
- 如果需要对鉴权逻辑进行整体改造，可以通过实现 org.hzero.gateway.helper.api.AuthenticationHelper 接口来完全定制化鉴权的部分。
- 如果仅需要对现有鉴权逻辑新增逻辑，可以通过实现 org.hzero.gateway.helper.api.HelperFilter 接口来新增鉴权逻辑。

```java
/**
 * 自定义鉴权过滤器，实现 org.hzero.gateway.helper.api.HelperFilter 接口
 */
@Component
public class CustomFilter implements HelperFilter {
    public CustomFilter() {
    }
    /**
     * 指定过滤器顺序，可在标准过滤器之前执行，数字越小，优先级越高
     */
    @Override
    public int filterOrder() {
        return 50;
    }
    /**
     * 是否执行此过滤器，false 则跳过此过滤器
     */
    @Override
    public boolean shouldFilter(RequestContext context) {
        return true;
    }
    /**
     * 具体的鉴权逻辑，返回 true，则鉴权通过，返回 false，则鉴权不通过
     *
     * @param context RequestContext 包含了API请求相关的所有信息
     */
    @Override
    public boolean run(RequestContext context) {
        if (true) {
            context.response.setStatus(CheckState.SUCCESS_PASS_SITE);
            context.response.setMessage("Have access to this api.");
            return true;
        } else {
            context.response.setStatus(CheckState.PERMISSION_NOT_PASS);
            context.response.setMessage("No access to this api.");
            return false;
        }
    }
}
```

### 签名API

GatewayHelper 支持签名方式对API鉴权，调用方通过提供的算法生成签名，网关验证签名通过后，即可访问API。需注意的是，签名API与公开API类似，无法获取用户信息。

#### 启用签名鉴权

- 首先需在gateway配置文件中启用API签名鉴权，然后配置客户端签名ID和签名密钥，并分发给客户端使用。

```yaml
hzero:
  gateway:
    helper:
      ## 启用API签名
      signature:
        enabled: false
        secrets:
          - secretId: hzero
            secretKey: xxxxxxxxxxxxxx
          - secretId: srm
            secretKey: xxxxxxxxxxxxxxxx
```

#### 客户端签名

- 客户端需先下载客户端签名工具：[ClientSignatureUtils.java](http://open.hand-china.com/files/docs/service/gateway/ClientSignatureUtils.java)
- 在调用HZERO API前，需先将请求参数封装到 Map 中，然后调用 `ClientSignatureUtils.buildSignature` 方法生成签名

```java
/**
 * 根据参数等信息获取签名
 *
 * @param params 请求参数
 * @param method 请求方法，支持 HttpMethod#POST、HttpMethod#GET、HttpMethod#DELETE、HttpMethod#PUT
 * @param secretId 密钥Id
 * @param secretKey 签名密钥
 * @return 签名
 */
public static String buildSignature(Map<String, Object> params, HttpMethod method, String secretId, String secretKey) {
       // ...
}
```

- 生成签名后，将签名加入参数中再调用HZERO API即可。

#### 定制化签名

如果标准的签名方式或算法不满足需求，可在gateway服务中定制签名认证。

- 定义 `org.hzero.gateway.helper.service.SignatureService` 的实现类，实现 `verifySignature` 方法即可。方法返回 `true` 则表示签名认证通过，返回 `false` 则表示签名认证不通过。具体的签名算法和客户端签名工具可自行实现。

```java
public interface SignatureService {
	/**
	 * API 签名验证
	 * 
	 * @param requestContext RequestContext，包含请求的所有信息
	 * @return true-验证通过; false-验证不通过
	*/
	boolean verifySignature(RequestContext requestContext);
}
```

---

# 认证服务

## OAuth认证服务

> 服务简码 `HOTH`
>
> 默认端口 `8020`
>
> 默认路由 `/oauth/**`
>
> 组件编码 `hzero-oauth`

### 简介

`hzero-oauth` 服务是基于 `Spring Security`、`Spring OAuth2`、`JWT` 实现的统一认证服务中心，登录基于 spring security 的标准登录流程，客户端授权支持 `oauth2.0` 的四种授权模式：`授权码模式`、`简化模式`、`密码模式`、`客户端模式`，授权流程跟标准的 oauth2 流程一致。web 端采用`简化模式(implicit)`登录系统，移动端可使用`密码模式(password)`登录系统 。并支持基于 `Spring Social` 的三方账号登录方式(如微信)。

### 组件坐标

```xml
<dependency>
    <groupId>org.hzero</groupId>
    <artifactId>hzero-oauth</artifactId>
    <version>${hzero.service.version}</version>
</dependency>
```

### 主要功能

- 统一登录界面
- 账户、手机、邮箱登录
- 短信登录
- 第三方登录功能
- 可客制化登录模板

### 服务配置

OAuth 服务的参数配置使用场景可具体参考 OAuth 服务下的其它文档。

```yaml
hzero:
  oauth:
    # 认证服务器 自定义资源匹配器
    # 可实现 ResourceMatcher 接口，自定义 OAuth ResourceServer 对哪些API认证
    custom-resource-matcher: false
    # 授权码模式验证 client 时不检查 client 的一致性
    not-check-client-equals: false
    # 移动设备ID参数
    device-id-parameter: device_id
    # 登录设备来源参数
    source-type-parameter: source_type
    # 移动端开启图形验证码校验，默认不开启
    enable-app-captcha: false
    # 始终开启图形验证码校验，默认否
    # 设置为 true 时，在进入登录页面时就显示图形验证码
    enable-always-captcha: false
    # client_credentials 模式是否返回 refresh_token，标准模式不返回
    credentials-allow-refresh: false
    # 登录页面标题
    title: HZERO
    # 版权信息
    copyright: ${HZERO_OAUTH_COPYRIGHT:Copyright © The HZERO Author®. All rights reserved.}
    # Logo URL
    logo-url: ${HZERO_OAUTH_LOGO_URL:/oauth/static/main/img/logo.svg}
    # 登录页面默认语言
    default-language: ${HZERO_OAUTH_DEFAULT_LANGUAGE:zh_CN}
    # 是否显示切换语言
    show-language: ${HZERO_OAUTH_SHOW_LANGUAGE:true}
    login:
      #网关是否启用https
      enable-https: ${HZERO_OAUTH_LOGIN_ENABLE_HTTPS:false}
      #开放给外部的oauth网关地址，支持https
      gateway-domain: ${HZERO_OAUTH_LOGIN_GATEWAY_DOMAIN:http://dev.hzero.org:8080/oauth}
      # 允许使用的登录名，默认有 用户名、邮箱、手机号
      support-fields: username,email,phone
      # 手机登录参数
      mobile-parameter: phone
      # 登录页面默认模板，oauth 提供了两套模板
      # 在请求 /oauth/authorize 接口时，可通过 template 参数指定使用的模板
      default-template: slide
      # 默认登录成功跳转地址
      # 在直接访问 oauth 的登录地址时，登录成功后会跳转到这个默认地址
      success-url: http://dev.hzero.org/workplace
    social:
      # 三方登录启用 https
      enable-https: ${HZERO_OAUTH_LOGIN_ENABLE_HTTPS:false}  
    logout:
      # 退出时是否清理token
      clear-token: true
    sso:
      # 是否启用二级域名单点登录
      enabled: false
      service: 
        # oauth 服务地址
        baseUrl: http://dev.hzero.org:8080/oauth
      # SAML 协议登录相关配置  
      saml:
        entity_id: hzero:org:sp
        passphrase: secret
        private_key: MIIEvQIBADANBgk......
        certificate: MIIDEzCCA.......
    password:
      # 是否启用 RSA 加密
      enable-encrypt: true
      # 密码传输加密：公钥
      public-key: MFwwDQYJKoZIhvcNAQEBB......
      # 密码传输加密：私钥
      private-key: MIIBVQIBADANBgkqhkiG......
```

- 设置 session 超时时间

在启动类上加如下注解设置 HttpSession 超时时间

```java
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 600)
```

### 密码加密配置

- 密码传输使用 RSA 非对称加密，注意一定要设置加密的公钥和私钥，可以直接从配置文件中拷贝，也可以使用如下工具方法生成自定义的公钥和私钥。

```java
public static void main(String[] args) {
      Pair<String, String> key = EncryptionUtils.RSA.generateKeyPair();
      String privateKey = key.getFirst();
      String publicKey = key.getSecond();
      System.out.println("PrivateKey >>>\n" + privateKey + "\n");
      System.out.println("PublicKey >>>\n" + publicKey + "\n");
      String content = "12345678";
      System.out.println("Content >>>\n" + content + "\n");
      // 使用公钥加密
      String encrypt = EncryptionUtils.RSA.encrypt(content, publicKey);
      // 使用私钥解密
      String decrypt = EncryptionUtils.RSA.decrypt(encrypt, privateKey);
      System.out.println("Encrypt >>>\n" + encrypt + "\n");
      System.out.println("Decrypt >>>\n" + decrypt);
  }
```

- 如果覆盖或重定义了登录页面，后端访问登录页面时(/login)，默认会在 Model 中返回 `publicKey` 公钥，前端访问登录接口时，需使用 publicKey 将密码加密后传输。前端需引入 `/public/static/main/js/jsencrypt.min.js` 加密工具。使用方式如下

```js
<input id="publicKey" type="hidden" th:value="${publicKey}" />
  function encryptPwd(password, publicKey) {
      // 初始化加密器
      const encrypt = new JSEncrypt();
      // 设置公钥
      encrypt.setPublicKey(publicKey);
      // 加密
      return encrypt.encrypt(password);
  }
```

- 如果后端需要对密码加密，可以使用 `org.hzero.core.util.EncryptionUtils` 工具，使用方式如下

```java
public String encryptPwd(String password, String publicKey) {
      return EncryptionUtils.RSA.encrypt(password, publicKey);
  }
```

---

## 标准登录

**可直接访问** OAuth 登录地址进行登录，`http://domain/oauth/login`，需配置默认的登录成功跳转地址，否则登录成功后会默认跳回到登录页面。(或者自动跳转至 OAuth 登录地址)

登录的字段默认支持 `用户名(username)、邮箱(email)、手机号(phone)`，可通过 `support-fields` 配置限制登录方式。

```yaml
hzero:
  oauth:
    # 标题
    title: ${HZERO_OAUTH_TITLE:HZERO}
    login:
      # 允许使用的登录名，默认有 用户名、邮箱、手机号
      support-fields: ${HZERO_OAUTH_LOGIN_SUPPORT_FIELDS:username,email,phone}
      # 默认登录成功跳转地址
      success-url: ${HZERO_OAUTH_LOGIN_SUCCESS_URL:http://domain/index}
```

### 用户锁定

登录流程中，用户校验主要会涉及 账号有效性、租户有效性、角色分配 等校验。

其中，如果用户输入密码错误，增加密码错误次数(通过缓存记录)，查询用户所属租户的安全策略，接着检查是否达到了`最大错误次数`，如果`允许锁定用户`，则`将用户锁定`。

用户密码错误，如果`启用了验证码`，且密码错误次数超过`验证码检查阀值`则会校验验证码，进入登录页面时会判断是否显示验证码。

用户锁定之后可以通过`忘记密码`找回，或者在`账户管理`处解锁用户。

- 与用户密码、登录相关的请在 **安全策略** 下配置。

<img src="http://172.21.61.12:9000/hsop-doc/doc_classify/0/ae3cea24b59842d9b0f0c5747ad5f59d/oauth_1568094984.png" alt="oauth_1568094984.png" style="zoom:80%;" />

### Web端授权

OAuth 标准登录授权流程

<img src="http://172.21.61.12:9000/hsop-doc/doc_classify/0/6122d3912ead46458b76cc579002eda8/1563627951.png" alt="1563627951.png" style="zoom:80%;" />

[http://open.hand-china.com/document-center/doc/product/10003/10011?_back=%2Fdocument-center%3Fs%3D%25E4%25BB%25BB%25E5%258A%25A1%25E8%25B0%2583%25E5%25BA%25A6#%E6%A0%87%E5%87%86%E7%99%BB%E5%BD%95](http://open.hand-china.com/document-center/doc/product/10003/10011?_back=%2Fdocument-center%3Fs%3D%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6#标准登录)